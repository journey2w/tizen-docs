<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>

  System &middot; Tizen Platform

</title>

<!-- Bootstrap CSS -->
<link href="/assets/bootstrap-4.0.0-beta/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- FontAwesome -->
<link href="/assets/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<!-- Favicon -->
<link href="/assets/favicon.ico" rel="icon">

  <!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="/assets/bootstrap-4.0.0-beta/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="/assets/bootstrap-4.0.0-beta/assets/js/vendor/popper.min.js"></script>
<script src="/assets/bootstrap-4.0.0-beta/dist/js/bootstrap.min.js"></script>
<script src="/assets/bootstrap-4.0.0-beta/assets/js/vendor/anchor.min.js"></script>
<script src="/assets/bootstrap-4.0.0-beta/assets/js/vendor/clipboard.min.js"></script>
<script src="/assets/bootstrap-4.0.0-beta/assets/js/vendor/holder.min.js"></script>

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/assets/bootstrap-4.0.0-beta/assets/js/ie10-viewport-bug-workaround.js"></script>
<script src="/assets/bootstrap-4.0.0-beta/assets/js/ie-emulation-modes-warning.js"></script>

<!-- Search highlight -->
<script src="/assets/js/search/highlight.js"></script>

</head>
<body>
  <!-- Navigation bar -->
<link href="/assets/css/navbar.css" rel="stylesheet">
<nav class="navbar navbar-expand-md navbar-dark fixed-top">
  <a class="navbar-brand" href="/index.html">
    <i class="fa fa-star" aria-hidden="true"></i>
  </a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarCollapse">
    <ul class="navbar-nav mr-auto">
      
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
          
          
    <li class="nav-item ">
      <a class="nav-link" href="/home/">Docs</a>
    </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
          
          
    <li class="nav-item active dropdown">
      <a class="nav-link dropbtn">Open Source Project <i class="fa fa-caret-down" aria-hidden="true"></i></a>
      <div class="dropdown-content">
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/overview/tizen-open-source-project">Overview</a>
                
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/developing/installing">Developing</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/porting/overview">Porting</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/reference/gerrit-usage">Reference</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/release-notes/tizen-4-0-m2">Release Notes</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/open-source-project/compliance/compliance-program">Compliance</a>
                
              
            
              
              
                
        <a href="/open-source-project/tizen-rt/">Tizen RT</a>
                
              
            
              
              
            
              
              
                
        <a href="/open-source-project/tizen-studio/overview">Tizen Studio</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
      </div>
    </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
          
          
    <li class="nav-item  dropdown">
      <a class="nav-link dropbtn">Application <i class="fa fa-caret-down" aria-hidden="true"></i></a>
      <div class="dropdown-content">
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/application/overview/">Overview</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/application/native/overview">Native Application</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
                
        <a href="/application/design/introduction">Design</a>
                
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
      </div>
    </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
    </ul>
    <form class="form-inline mt-2 mt-md-0" action="/search" method="get">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search" id="search-box" name="q">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit" value="search">Search</button>
    </form>
  </div>
</nav>
<!-- Navigation bar end -->

  <link href="/assets/css/solution.css" rel="stylesheet">
<link href="/assets/css/markdown.css" rel="stylesheet">
<div class="container-fluid">
  <!-- Sidebar -->
<link href="/assets/css/sidebar.css" rel="stylesheet">
<nav class="col-sm-3 col-md-2 d-none d-sm-block bg-light sidebar">




  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    
  <div class="item-root item-first">
      
    <a href="/open-source-project/overview/tizen-open-source-project">Overview</a>
      
  </div>
    
    
  

  
  

  
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/developing/installing">Developing</a>
      
  </div>
    
    
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    
  <div class="item-root active ">
    <a href="/open-source-project/porting/overview">Porting</a>
    <ul>
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/overview/">Overview</a>
        
      </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/kernel/">Kernel</a>
        
      </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/recovery/">System Recovery</a>
        
      </li>
          
        
      
        
        
          
      <li class="active">
			  <a href="/open-source-project/porting/system/">System</a>
      </li>
      <ul>
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
      </ul>
          
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/graphics-and-ui/">Graphics and UI</a>
        
      </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/multimedia/">Multimedia</a>
        
      </li>
          
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/connectivity/">Connectivity</a>
        
      </li>
          
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/location/">Location</a>
        
      </li>
          
        
      
        
        
      
        
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/telephony/">Telephony</a>
        
      </li>
          
        
      
        
        
          
      <li>
        
        <a href="/open-source-project/porting/application/">Application</a>
        
      </li>
          
        
      
    </ul>
  </div>
    
    
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/reference/gerrit-usage">Reference</a>
      
  </div>
    
    
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/release-notes/tizen-4-0-m2">Release Notes</a>
      
  </div>
    
    
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/compliance/compliance-program">Compliance</a>
      
  </div>
    
    
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/tizen-rt/">Tizen RT</a>
      
  </div>
    
    
  

  
  

  
  
    
  <div class="item-root ">
      
    <a href="/open-source-project/tizen-studio/overview">Tizen Studio</a>
      
  </div>
    
    
  

  
  

  
  

  
  

  
  

  
  

</nav>
<!-- Sidebar end -->

  <main class="col-sm-9 ml-sm-auto col-md-10 pt-3">
  <div class="bd-content doc-content">
    <h1 id="system">System</h1>

<p>You can implement various features relatesd to the System framework and the file system.</p>

<h2 id="partition-and-file-system">Partition and File System</h2>

<p>The following description is an example of the Tizen partition layout. Product vendors can modify the sequence or partition layout for their devices, as needed.</p>

<ol>
  <li>The <code class="highlighter-rouge">boot</code> partition includes the kernel image, boot-loader image, and modem image. It can also contain device driver modules.</li>
  <li>The <code class="highlighter-rouge">rootfs</code> partition is mounted on the root directory. It contains the fundamental frameworks for Tizen and some general utilities for Linux.</li>
  <li>The <code class="highlighter-rouge">system-data</code> partition is mounted on the <code class="highlighter-rouge">/opt</code> directory. It contains the platform database and platform configurations.</li>
  <li>The <code class="highlighter-rouge">user</code> partition can be mounted on the <code class="highlighter-rouge">/opt/usr</code> directory separately. It contains user-installed applications.</li>
  <li>External storages are mounted on <code class="highlighter-rouge">/opt/media</code>.</li>
  <li>The partition image files (<code class="highlighter-rouge">rootfs.img</code>, <code class="highlighter-rouge">system-data.img</code>, and <code class="highlighter-rouge">user.img</code>) can be zipped for downloading, such as <code class="highlighter-rouge">&lt;IMAGE_NAME&gt;.tar.gz</code>.</li>
</ol>

<p>The <code class="highlighter-rouge">/etc/fstab</code> directory must be modified or the <code class="highlighter-rouge">systemd</code> mount units must be added based on the partition layout. Consequently, the <code class="highlighter-rouge">fstab</code> file or system mount unit files for specific devices must be added to the <code class="highlighter-rouge">system-plugin</code> Git repository. The following example shows an <code class="highlighter-rouge">fstab</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dev/root         /               ext4    defaults,noatime 0      1
LABEL=system-data /opt            ext4    defaults,noatime 0      2
LABEL=user        /opt/usr        ext4    defaults,noatime 0      3
</code></pre></div></div>

<h3 id="supported-file-systems">Supported File Systems</h3>

<p>Tizen supports the Extended 4 (Ext 4) file system as the default file system.</p>

<p>To enable support for other file systems, such as JFS, XFS, BTRFS, and Reiserfs, the Tizen kernel must be modified and compiled. The following configuration options must be enabled in the kernel configuration file:</p>

<ul>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS_XATTR=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_USE_FOR_EXT23=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS_SECURITY=y</code></li>
</ul>

<h3 id="file-system-hierarchy">File System Hierarchy</h3>

<p>The Tizen directory hierarchy intends to follow the File System Hierarchy Standard (FHS) as much as possible, for compatibility with the Linux world. However, Tizen uses the <code class="highlighter-rouge">/opt</code> directory for Tizen-specific purposes: place all RW data in the <code class="highlighter-rouge">/opt</code> directory.</p>

<p><strong>Figure: File system hierarchy</strong></p>

<p><img src="media/467px-fsh.png" alt="File system hierarchy" /></p>

<p>Directory macros for accessing the Tizen-specific directories are provided in the Tizen platform configuration metafile. The following table lists some example macros.</p>

<p><strong>Table: Example directory macros</strong>
| Directory macro | Real path    |
| —————- | ———— |
| <code class="highlighter-rouge">TZ_SYS_DATA</code>    | <code class="highlighter-rouge">/opt/data</code>  |
| <code class="highlighter-rouge">TZ_SYS_SHARE</code>   | <code class="highlighter-rouge">/opt/share</code> |
| <code class="highlighter-rouge">TZ_SYS_VAR</code>     | <code class="highlighter-rouge">/opt/var</code>   |</p>

<h2 id="system-framework">System Framework</h2>

<p>The System framework module abstracts low-level system functions and manages the Tizen system:</p>

<ul>
  <li><code class="highlighter-rouge">systemd</code> requirements for system and service management
    <ul>
      <li>Linux Kernel &gt;= 3.4 , Linux Kernel &gt;= 3.8 for Smack support</li>
      <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>, <code class="highlighter-rouge">CONFIG_TIMERFD</code>, <code class="highlighter-rouge">CONFIG_SIGNALFD</code>, <code class="highlighter-rouge">CONFIG_EPOLL</code>, …</li>
    </ul>
  </li>
  <li>Basic resource requirements (such as CPU, memory) usage management
    <ul>
      <li>Linux Kernel &gt;= 3.10 for <code class="highlighter-rouge">VMPRESSURE</code>, Linux Kernel &gt;= 3.8 for <code class="highlighter-rouge">MEMCG SWAP</code></li>
      <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>, <code class="highlighter-rouge">CONFIG_CGROUP_SCHED</code>, <code class="highlighter-rouge">CONFIG_MEMCG</code>, <code class="highlighter-rouge">CONFIG_MEMCG_SWAP</code>, …</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">deviced</code> requirements for device and power management
    <ul>
      <li>Device HAL layer porting</li>
    </ul>
  </li>
  <li>dlog requirements<br />
Select a backend for the target environment and enable the appropriate kernel feature:
    <ul>
      <li>Additional KMSG patch for multiple Kmsg backend</li>
      <li>Android™ logger driver for Android log backend</li>
      <li>Userspace logger daemon</li>
    </ul>
  </li>
</ul>

<p>Using the Linux kernel 3.10 or above is recommended.</p>

<p><strong>Figure: System framework</strong></p>

<p><img src="media/800px-systemfw.png" alt="System framework" /></p>

<h3 id="systemd">systemd</h3>

<p><code class="highlighter-rouge">systemd</code> (ver.219) is a system and service manager for the Tizen system. It provides functionalities, such as parallelized service execution, socket and dbus activation for starting services and daemons, on-demand daemon start-up, service process management using Linux <code class="highlighter-rouge">cgroup</code>, automount point support, and service snapshot and restore.</p>

<p>The <code class="highlighter-rouge">systemd</code> core manages all units, such as service, socket, and mount. It stores all log data. When you add a new service daemon, you need to provide the proper system units and unit dependencies.</p>

<p>To use <code class="highlighter-rouge">systemd</code>, you must enable the <code class="highlighter-rouge">cgroup</code> and <code class="highlighter-rouge">autofs</code> options in the <a href="https://wiki.tizen.org/Linux">Linux</a> kernel configuration. It also depends on dbus and some libraries.</p>

<h3 id="resourced">resourced</h3>

<p><code class="highlighter-rouge">resourced</code> is a daemon that manages system resources, such as memory and CPU.</p>

<p>To use most of the <code class="highlighter-rouge">resourced</code> functionalities, you must enable the following <code class="highlighter-rouge">cgroup</code> kernel features:</p>

<ul>
  <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>: Base feature</li>
  <li><code class="highlighter-rouge">CONFIG_CGROUP_SCHED</code>: Controls the CPU share of applications</li>
  <li><code class="highlighter-rouge">CONFIG_MEMCG</code>: Selects the victim in low-memory situations</li>
  <li><code class="highlighter-rouge">CONFIG_FREEZER</code>: Freezes background (and idle) applications</li>
  <li><code class="highlighter-rouge">CONFIG_MEMCG_SWAP</code>, <code class="highlighter-rouge">CONFIG_MEMCG_SWAP_ENABLED</code>, <code class="highlighter-rouge">CONFIG_ZRAM</code>, <code class="highlighter-rouge">CONFIG_ZSMALLOC</code>: Saves memory through compression</li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <p>To use the <code class="highlighter-rouge">resourced</code> freezer feature, you must install the freezer plugin by enabling <code class="highlighter-rouge">CONFIG_FREEZER</code>.</p>
</blockquote>

<h3 id="deviced">deviced</h3>

<p><code class="highlighter-rouge">deviced</code> is a daemon that handles device events, such as the battery level and plug-and-play device status, and provides interfaces to manage devices, such as power, display, and external storages. If your BSP does not provide the Linux kernel-standard interface, these functionalities can require a HAL layer:</p>

<ul>
  <li>Managing the LCD backlight state (on/off/dim)</li>
  <li>Managing the CPU sleep state and handling requests to lock the CPU from sleeping</li>
  <li>Monitoring external devices, such as USB cable, earjack, and charger</li>
  <li>Monitoring the battery level</li>
  <li>Managing external storages, such as SD card and USB storages</li>
  <li>Controlling the vibrator</li>
  <li>Setting the USB configuration for connecting to a host computer</li>
  <li>Powering off the LED, IR, and other features</li>
  <li>Using the device HAL to handle devices and get events</li>
</ul>

<h3 id="dlog">dlog</h3>

<p>Tizen provides 3 logging system backends:</p>

<ul>
  <li>Multiple <code class="highlighter-rouge">kmsg</code> backend<br />
Requires a kernel patch. For more information, see https://lwn.net/Articles/677047/.</li>
  <li>Android-logger backend<br />
Utilizes the Android logger driver.</li>
  <li>User logger backend<br />
No requirement (you do not have to enable anything from dlog)</li>
</ul>

<h3 id="porting-the-smart-development-bridge-sdb">Porting the Smart Development Bridge (SDB)</h3>

<p>SDB is a device management tool used for remote shell command, file transfer, controlling device log out, and USB debugging.</p>

<ul>
  <li>To use SDB, you must install a kernel driver.<br />
  For example:
    <ul>
      <li><a href="https://review.tizen.org/git/?p=profile/mobile/platform/kernel/linux-3.10-sc7730.git;a=blob;f=drivers/usb/gadget/slp.c;h=c0d935f5362cc5ae03807d3533fe84df88e8c354;hb=refs/heads/accepted/tizen_mobile">Gadget Driver for SLP based on Android</a></li>
      <li><a href="https://review.tizen.org/git/?p=profile/mobile/platform/kernel/linux-3.10-sc7730.git;a=blob;f=drivers/usb/gadget/f_sdb.c;h=7f334ba01139d6bcbe7668bd84582e078d563638;hb=refs/heads/accepted/tizen_mobile">Gadget Driver for Samsung SDB (based on Android ADB)</a></li>
    </ul>
  </li>
  <li>To recognize the target as a Tizen device, the SDB interface on the target device must have the following information in the USB interface descriptor:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Class: 0xff
  SubClass: 0x20
  Protocol: 0x02
</code></pre></div>    </div>
  </li>
  <li>When using multi-configuration, SDB must be located in the first configuration on the target multi-configuration system. The SDB client of the host PC (Linux PC) selects the first configuration.</li>
  <li>To recognize the USB cable connection, you must port the External Connector Class (<code class="highlighter-rouge">extcon</code>) to the kernel. If <code class="highlighter-rouge">extcon</code> cannot be ported, you can enable SDB using the following shell command:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/bin/direct_set_debug.sh <span class="nt">--sdb-set</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="porting-the-device-hal-interface">Porting the Device HAL Interface</h3>

<p>The device HAL is applied for the hardware-independent platform. The device HAL consists of libraries corresponding to hardware, such as display, external connector, battery, LED, and IR. The HAL is used by <code class="highlighter-rouge">deviced</code> (device daemon) to control hardware, and manages the events of device state changes. <code class="highlighter-rouge">deviced</code> opens the implemented libraries and uses the APIs to control the devices.</p>

<p>OEM developers must implement the API defined in the header files of the <code class="highlighter-rouge">libdevice-node</code> package and compile their libraries (<code class="highlighter-rouge">.so</code> file) for their devices.</p>

<p>The following code snippet shows the device HAL structure:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define MAKE_TAG_CONSTANT(A,B,C,D) (((A) &lt;&lt; 24) | ((B) &lt;&lt; 16) | ((C) &lt;&lt; 8) | (D))
#define HARDWARE_INFO_TAG MAKE_TAG_CONSTANT('T','H','I','T')
</span>
<span class="k">struct</span> <span class="n">hw_common</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">hw_info</span> <span class="p">{</span>
    <span class="cm">/* magic must be initialized to HARDWARE_INFO_TAG */</span>
    <span class="kt">uint32_t</span> <span class="n">magic</span><span class="p">;</span>
    <span class="cm">/* HAL version */</span>
    <span class="kt">uint16_t</span> <span class="n">hal_version</span><span class="p">;</span>
    <span class="cm">/* Device version */</span>
    <span class="kt">uint16_t</span> <span class="n">device_version</span><span class="p">;</span>
    <span class="cm">/* Device ID */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
    <span class="cm">/* Device name */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="cm">/* Author name */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">author</span><span class="p">;</span>
    <span class="cm">/* Module's dynamic shared object */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">dso</span><span class="p">;</span>
    <span class="cm">/* Reserved for future use */</span>
    <span class="kt">uint32_t</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="cm">/* Open device */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">);</span>
    <span class="cm">/* Close device */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hw_common</span> <span class="p">{</span>
    <span class="cm">/* Indicate to this device information structure */</span>
    <span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="battery-hal">Battery HAL</h4>

<p>The battery HAL provides functions for getting the battery status. The HAL interface is defined in the <code class="highlighter-rouge">hw/battery.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the battery HAL interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define BATTERY_HARDWARE_DEVICE_ID "battery"
</span>
<span class="cp">#define POWER_SOURCE_NONE "none"
#define POWER_SOURCE_AC "ac"
#define POWER_SOURCE_USB "usb"
#define POWER_SOURCE_WIRELESS "wireless"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define BATTERY_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">battery_info</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="cm">/* "display" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span> <span class="cm">/* "Charging", "Discharging", "Full", "Not charging" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">health</span><span class="p">;</span> <span class="cm">/* "Good", "Cold", "Dead", "Overheat", "Over voltage" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">power_source</span><span class="p">;</span> <span class="cm">/* "ac", "usb", "wireless" */</span>
    <span class="kt">int</span> <span class="n">online</span><span class="p">;</span> <span class="cm">/* 0 ~ */</span>
    <span class="kt">int</span> <span class="n">present</span><span class="p">;</span> <span class="cm">/* 0 or 1 */</span>
    <span class="kt">int</span> <span class="n">capacity</span><span class="p">;</span> <span class="cm">/* 0 ~ 100 */</span>
    <span class="kt">int</span> <span class="n">current_now</span><span class="p">;</span> <span class="cm">/* Current (uA). Positive value if power source is connected, negative value if power source is not connected */</span>
    <span class="kt">int</span> <span class="n">current_average</span><span class="p">;</span> <span class="cm">/* Average current (uA). Positive value if power source is connected, negative value if power source is not connected */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">BatteryUpdated</span><span class="p">)(</span><span class="k">struct</span> <span class="n">battery_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">battery_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Register battery event */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">register_changed_event</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unregister_changed_event</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">);</span>

    <span class="cm">/* Get current states */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_current_state</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the battery HAL functions.</p>

<p><strong>Table: Battery HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*register_changed_event)(BatteryUpdated updated_cb, void *data);</code></td>
      <td>Adds a callback function which is called when battery status changes.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">void (*unregister_changed_event)(BatteryUpdated updated_cb);</code></td>
      <td>Removes the callback function added for the battery status event.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_current_state)(BatteryUpdated updated_cb, void *data);</code></td>
      <td>Calls the function specified in the first parameter. The battery information is delivered to the function parameter.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the battery HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BATTERY_ROOT_PATH "/sys/class/power_supply"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_power_source</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_AC</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_AC</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_USB</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_USB</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_WIRELESS</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_WIRELESS</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_NONE</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_get_current_state</span><span class="p">(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">battery_info</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">health</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">power_source</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">updated_cb</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_ID</span><span class="p">;</span>


    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/battery/status"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/battery/health"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">health</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">health</span><span class="p">;</span>

    <span class="p">....</span>

    <span class="n">get_power_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_source</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">power_source</span> <span class="o">=</span> <span class="n">power_source</span><span class="p">;</span>

    <span class="n">updated_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">battery_device</span> <span class="o">*</span><span class="n">battery_dev</span><span class="p">;</span>
    <span class="n">battery_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">battery_device</span><span class="p">));</span>

    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">register_changed_event</span> <span class="o">=</span> <span class="n">battery_register_changed_event</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">unregister_changed_event</span> <span class="o">=</span> <span class="n">battery_unregister_changed_event</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">get_current_state</span> <span class="o">=</span> <span class="n">battery_get_current_state</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">battery_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"battery"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">battery_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">battery_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="display-hal">Display HAL</h4>

<p>The display HAL provides functions for controlling the display brightness. The HAL interface is defined in the <code class="highlighter-rouge">hw/display.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the display HAL interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define DISPLAY_HARDWARE_DEVICE_ID "display"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define DISPLAY_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,2)
</span>
<span class="k">struct</span> <span class="n">display_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control display brightness */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_max_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the display HAL functions.</p>

<p><strong>Table: Display HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*get_max_brightness)(int *brightness)</code></td>
      <td>Returns the maximum brightness value the display driver supports.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_brightness)(int *brightness)</code></td>
      <td>Returns the current brightness value.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*set_brightness)(int brightness)</code></td>
      <td>Sets the brightness value.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the display HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef BACKLIGHT_PATH
#define BACKLIGHT_PATH "/sys/class/backlight/panel"
#endif
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_get_max_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/max_brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">max</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_get_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="o">*</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_set_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="n">display_get_max_brightness</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
        <span class="n">brightness</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">brightness</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">display_device</span> <span class="o">*</span><span class="n">display_dev</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">common</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">display_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">display_device</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">get_max_brightness</span> <span class="o">=</span> <span class="n">display_get_max_brightness</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">display_get_brightness</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">set_brightness</span> <span class="o">=</span> <span class="n">display_set_brightness</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">display_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">DISPLAY_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">DISPLAY_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Display"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">display_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">display_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="external-connector-hal">External Connector HAL</h4>

<p>The external connector HAL provides functions for getting the external connector device status. The HAL interface is defined in the <code class="highlighter-rouge">hw/external_connection.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> needs to be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the external connector HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define EXTERNAL_CONNECTION_HARDWARE_DEVICE_ID "external_connection"
</span>
<span class="cp">#define EXTERNAL_CONNECTION_USB "USB"
#define EXTERNAL_CONNECTION_USB_HOST "USB-HOST"
#define EXTERNAL_CONNECTION_TA "TA"
#define EXTERNAL_CONNECTION_HDMI "HDMI"
#define EXTERNAL_CONNECTION_DOCK "Dock"
#define EXTERNAL_CONNECTION_MIC "Microphone"
#define EXTERNAL_CONNECTION_HEADPHONE "Headphone"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define EXTERNAL_CONNECTION_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">connection_info</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ConnectionUpdated</span><span class="p">)(</span><span class="k">struct</span> <span class="n">connection_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">external_connection_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Register external_connection event */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">register_changed_event</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unregister_changed_event</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">);</span>

    <span class="cm">/* Get current states */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_current_state</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the external connector HAL functions.</p>

<p><strong>Table: External connector HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*register_changed_event)(ConnectionUpdated updated_cb, void *data);</code></td>
      <td>Adds a callback function which is called when the external connector status changes.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">void (*unregister_changed_event)(ConnectionUpdated updated_cb);</code></td>
      <td>Removes the callback function added for the external connector status event.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_current_state)(ConnectionUpdated updated_cb, void *data);</code></td>
      <td>Calls the function specified in the first parameter. The external connector information is delivered to the function parameter.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the external connector HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SWITCH_ROOT_PATH "/sys/devices/virtual/switch"
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">switch_device</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span> <span class="n">switch_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_USB</span><span class="p">,</span> <span class="s">"usb_cable"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_DOCK</span><span class="p">,</span> <span class="s">"dock"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_HEADPHONE</span><span class="p">,</span> <span class="s">"earjack"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_switch_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">node</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s">"%s/%s/state"</span><span class="p">,</span> <span class="n">SWITCH_ROOT_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">fp</span><span class="p">));</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">external_connection_get_current_state</span><span class="p">(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">connection_info</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">switch_devices</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">read_switch_state</span><span class="p">(</span><span class="n">switch_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
        <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">switch_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
        <span class="n">updated_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_switch_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">node</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s">"%s/%s/state"</span><span class="p">,</span> <span class="n">SWITCH_ROOT_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">fp</span><span class="p">));</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">external_connection_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">EXTERNAL_CONNECTION_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">EXTERNAL_CONNECTION_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"external_connection"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">external_connection_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">external_connection_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="led-hal">LED HAL</h4>

<p>The LED HAL provides functions for controlling LEDs. The HAL interface is defined in the <code class="highlighter-rouge">hw/led.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the LED HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define LED_HARDWARE_DEVICE_ID  "led"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define LED_HARDWARE_DEVICE_VERSION MAKE_VERSION(1,0)
</span>
<span class="cm">/*
   LED device ID
*/</span>
<span class="cp">#define LED_ID_CAMERA_BACK "camera_back"
#define LED_ID_CAMERA_FRONT "camera_front"
#define LED_ID_NOTIFICATION "notification"
#define LED_ID_TOUCH_KEY "touch_key"
</span>
<span class="k">enum</span> <span class="n">led_type</span> <span class="p">{</span>
    <span class="n">LED_TYPE_MANUAL</span><span class="p">,</span>
    <span class="n">LED_TYPE_BLINK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_state</span> <span class="p">{</span>
    <span class="cm">/* LED type */</span>
    <span class="k">enum</span> <span class="n">led_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="cm">/*
       The first byte means opaque and the other 3 bytes are RGB values.
       You can use opaque byte as a led brightness value.
       If the first byte is 0x00, led is switched off.
       Anything else is worked as on. The max value is 0xFF.
    */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">color</span><span class="p">;</span>
    <span class="cm">/* Turn on time in milliseconds */</span>
    <span class="kt">int</span> <span class="n">duty_on</span><span class="p">;</span>
    <span class="cm">/* Turn off time in milliseconds */</span>
    <span class="kt">int</span> <span class="n">duty_off</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_state</span><span class="p">)(</span><span class="k">struct</span> <span class="n">led_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the LED HAL functions.</p>

<p><strong>Table: LED HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*set_state)(struct led_state *state);</code></td>
      <td>Sets the LED play style and plays LED lights.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the LED HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef CAMERA_BACK_PATH
#define CAMERA_BACK_PATH "/sys/class/leds/torch-sec1"
#endif
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">camera_back_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">brt</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_BLINK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"camera back led does not support LED_TYPE_BLINK mode"</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">CAMERA_BACK_PATH</span><span class="s">"/max_brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">max</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">brt</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">brt</span> <span class="o">=</span> <span class="n">brt</span> <span class="o">/</span> <span class="mf">255.</span><span class="n">f</span> <span class="o">*</span> <span class="n">max</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">brt</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">CAMERA_BACK_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">led_device</span> <span class="n">camera_back_dev</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">set_state</span> <span class="o">=</span> <span class="n">camera_back_set_state</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_device_list</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">led_device</span> <span class="o">*</span><span class="n">operations</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">led_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span> <span class="n">led_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">LED_ID_CAMERA_BACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">camera_back_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_CAMERA_FRONT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_NOTIFICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_TOUCH_KEY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">led_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">id_len</span><span class="p">;</span>

    <span class="n">list_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">led_list</span><span class="p">);</span>
    <span class="n">id_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="n">id_len</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">operations</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">list_len</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_device</span><span class="p">));</span>

    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_state</span>
        <span class="o">=</span> <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">operations</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">;</span>

<span class="nl">out:</span>
    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">led_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">LED_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">LED_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Default LED"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">led_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">led_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="ir-hal">IR HAL</h4>

<p>The IR HAL provides functions for controlling IR transmission. The HAL interface is defined in the <code class="highlighter-rouge">hw/ir.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the IR HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define IR_HARDWARE_DEVICE_ID "ir"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define IR_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">ir_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control the IR state */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">is_available</span><span class="p">)(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">available</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">transmit</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">frequency_pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the IR HAL functions.</p>

<p><strong>Table: IR HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*is_available)(bool *available);</code></td>
      <td>Returns whether the target device supports IR transmission.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*transmit)(int *frequency_pattern, int size);</code></td>
      <td>Transmits IR with frequency pattern and its size.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the IR HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define IRLED_CONTROL_PATH "/sys/class/ir/ir_send"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_is_available</span><span class="p">(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">available</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">available</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_transmit</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">frequency_pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">frequency_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">IRLED_CONTROL_PATH</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ir_device</span> <span class="o">*</span><span class="n">ir_dev</span><span class="p">;</span>

    <span class="n">ir_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ir_device</span><span class="p">));</span>

    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">ir_is_available</span><span class="p">;</span>
    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">transmit</span> <span class="o">=</span> <span class="n">ir_transmit</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">ir_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">IR_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IR_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ir"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ir_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ir_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="touchscreen-hal">Touchscreen HAL</h4>

<p>The touchscreen HAL provides functions for switching the touchscreen on and off. The HAL interface is defined in the <code class="highlighter-rouge">hw/touchscreenf.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the touchscreen HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define TOUCHSCREEN_HARDWARE_DEVICE_ID "touchscreen"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define TOUCHSCREEN_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="p">{</span>
    <span class="n">TOUCHSCREEN_OFF</span><span class="p">,</span> <span class="cm">/* Disable touchscreen */</span>
    <span class="n">TOUCHSCREEN_ON</span><span class="p">,</span> <span class="cm">/* Enable touchscreen */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">touchscreen_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control touchscreen state */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_state</span><span class="p">)(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_state</span><span class="p">)(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="n">state</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the touchscreen HAL functions.</p>

<p><strong>Table: Touchscreen HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*get_state)(enum touchscreen_state *state);</code></td>
      <td>Returns whether the touchscreen is enabled.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*set_state)(enum touchscreen_state state);</code></td>
      <td>Enables and disables the touchscreen.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the touchscreen HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define TURNON_TOUCHSCREEN 1
#define TURNOFF_TOUCHSCREEN 0
#define TOUCHSCREEN_PATH "/sys/class/input/touchscreen/enable"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_get_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TOUCHSCREEN_PATH</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">TURNOFF_TOUCHSCREEN</span><span class="p">:</span>
        <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_OFF</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">TURNON_TOUCHSCREEN</span><span class="p">:</span>
        <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_ON</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_set_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">TOUCHSCREEN_OFF</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">TURNOFF_TOUCHSCREEN</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">TOUCHSCREEN_ON</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">TURNON_TOUCHSCREEN</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TOUCHSCREEN_PATH</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">touchscreen_device</span> <span class="o">*</span><span class="n">touchscreen_dev</span><span class="p">;</span>

    <span class="n">touchscreen_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">touchscreen_device</span><span class="p">));</span>

    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">get_state</span> <span class="o">=</span> <span class="n">touchscreen_get_state</span><span class="p">;</span>
    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">set_state</span> <span class="o">=</span> <span class="n">touchscreen_set_state</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">touchscreen_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"touchscreen"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">touchscreen_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">touchscreen_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="sensor-framework">Sensor Framework</h2>

<p>Sensor devices are used widely in mobile devices to enhance the user experience. Most modern mobile operating systems have a framework which manages hardware and virtual sensors on the platform and provides convenient APIs to the application.</p>

<p>Sensors can be classified into hardware and virtual sensors. Tizen supports individual HALs for the following sensors:</p>

<ul>
  <li>Hardware sensors
    <ul>
      <li>Accelerometer</li>
      <li>Geomagnetic sensor</li>
      <li>Gyroscope</li>
      <li>Light sensor</li>
      <li>Proximity sensor</li>
      <li>Pressure sensor</li>
      <li>Ultraviolet sensor</li>
      <li>Temperature sensor</li>
      <li>Humidity sensor</li>
      <li>HRM (Heart Rate Monitor)</li>
      <li>HRM LED green sensor</li>
      <li>HRM LED IR sensor</li>
      <li>HRM LED red sensor</li>
      <li>Uncalibrated geomagnetic sensor</li>
      <li>Uncalibrated gyroscope sensor</li>
      <li>Human pedometer</li>
      <li>Human sleep monitor</li>
      <li>Human sleep detector</li>
      <li>Human stress monitor</li>
    </ul>
  </li>
  <li>Virtual sensors
    <ul>
      <li>Orientation sensor</li>
      <li>Gravity sensor</li>
      <li>Linear acceleration sensor</li>
      <li>Rotation vector sensor</li>
      <li>Gyroscope rotation vector sensor</li>
      <li>Geomagnetic rotation vector sensor</li>
    </ul>
  </li>
</ul>

<p>The sensor framework provides a sensor server for managing sensor HALs and a medium through which client applications are connected to the sensor handler to exchange data.</p>

<p><strong>Figure: Sensor framework architecture</strong></p>

<p><img src="media/678px-tizen-3-sensorfw.png" alt="Sensor framework architecture" /></p>

<p>The sensor HALs retrieve data from sensor hardware and enable client applications to use the data for specific requirements.</p>

<p>The Sensor framework consists of the following components:</p>

<ul>
  <li>Sensor client library<br />
Any application that wants to access the sensor server and communicate with it must use the sensor API library. Using the Sensor API, the application can control sensors and receive sensor events from the sensor server. By using the sensor API, any application or middleware framework can have the sensor client library executing within its own process context.</li>
  <li>Sensor server<br />
The sensor server is a daemon which communicates uniquely to multiple sensors (through drivers) in the system and dispatches sensor data or events back to the application. The sensor server is responsible for initializing the sensors during boot, driver configuration, sensor data fetching and delivery, and managing all sensors and clients on the platform.</li>
  <li>Sensor HAL (Hardware Abstraction Layer)<br />
The sensor HAL, which is interfaced to the sensor server, is responsible for interacting with the sensor drivers. The HAL processes data from the sensor drivers and communicates it to the server. Hardware sensors must support the HAL. The sensor HAL is implemented as a shared library. The <code class="highlighter-rouge">sensor_loader</code> finds the <code class="highlighter-rouge">hal.so</code> library in the <code class="highlighter-rouge">/usr/lib/sensor/</code> directory, and loads it at boot time.</li>
</ul>

<h3 id="porting-the-hal-interface">Porting the HAL Interface</h3>

<p>You can port individual sensors or a sensorhub.</p>

<h4 id="sensor">Sensor</h4>

<p>To port new hardware sensors, the HAL library-inherited <code class="highlighter-rouge">sensor_device</code> interface must be implemented. The HAL header files can be found at <code class="highlighter-rouge">git:sensord/src/hal</code>.</p>

<p>The Tizen HAL sensor types are also defined in the <code class="highlighter-rouge">sensor_hal_types.h</code> header file under the names <code class="highlighter-rouge">SENSOR_DEVICE_...</code>.</p>

<p><strong>Figure: Sensor HAL</strong></p>

<p><img src="media/tizen-3-sensor-fw-hal.png" alt="Sensor HAL" /></p>

<p>The following code snippet shows the interface of the sensor HAL in the <code class="highlighter-rouge">sensor_hal.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Create devices
*/</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sensor_device_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create_t</span><span class="p">)(</span><span class="n">sensor_device_t</span> <span class="o">**</span><span class="n">devices</span><span class="p">);</span>

<span class="cm">/*
   Sensor device interface
   1 device must be abstracted from 1 device event node
*/</span>
<span class="k">class</span> <span class="nc">sensor_device</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">sensor_device</span><span class="p">()</span> <span class="p">{}</span>

    <span class="kt">uint32_t</span> <span class="n">get_hal_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SENSOR_HAL_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">set_batch_latency</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">set_attribute_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">set_attribute_str</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">flush</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table describes the functions of the <code class="highlighter-rouge">sensor_device</code> interface.</p>

<p><strong>Table: sensor_device interface functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Prototype</th>
      <th>Description</th>
      <th>Return value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">uint32_t get_hal_version(void)</code></td>
      <td>Returns the HAL version.</td>
      <td>Version</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_poll_fd(void)</code></td>
      <td>Returns the file description to poll events.</td>
      <td><code class="highlighter-rouge">fd</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_sensors(const sensor_info_t **sensors)</code></td>
      <td>Returns the list of supported sensors. See the <code class="highlighter-rouge">sensor_info_t</code> in the <code class="highlighter-rouge">sensor_hal_types.h</code> header file.</td>
      <td>Size</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool enable(uint32_t id)</code></td>
      <td>Enables the sensor.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool disable(uint32_t id)</code></td>
      <td>Disables the sensor.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int read_fd(uint32_t **ids)</code></td>
      <td>Returns the sensor device IDs. The sensor framework calls this function when an event is detected from the <code class="highlighter-rouge">poll-fd</code>.</td>
      <td>Size</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_data(uint32_t id, sensor_data_t **data, int *length)</code></td>
      <td>Updates the <code class="highlighter-rouge">sensor_data_t</code> object (data) with details about the sensor, such as accuracy, timestamp, and values. Note that the <code class="highlighter-rouge">sensor_data_t</code> object must be created using the <code class="highlighter-rouge">malloc()</code> function.</td>
      <td>0 on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_interval(uint32_t id, unsigned long val)</code></td>
      <td>Sets the interval.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_batch_latency(uint32_t id, unsigned long val)</code></td>
      <td>Sets the batch latency.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_attribute_int(uint32_t id, int32_t attribute, int32_t value)</code></td>
      <td>Sets the <code class="highlighter-rouge">int</code> value to the attribute.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_attribute_str(uint32_t id, int32_t attribute, char *value, int value_len)</code></td>
      <td>Sets the <code class="highlighter-rouge">string</code> value to the attribute.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool flush(uint32_t id)</code></td>
      <td>Flushes the sensor events.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (create_t *)(sensor_device_t **devices)</code></td>
      <td>Returns the <code class="highlighter-rouge">sensor_device</code> list. To create the sensor module in <code class="highlighter-rouge">sensord</code>, you must implement this interface.</td>
      <td>Size</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows the interface of the sensor HAL types in the <code class="highlighter-rouge">sensor_hal_type.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Sensor Types
   These types are used to control the sensors

   - base unit
     acceleration values : meter per second^2 (m/s^2)
     magnetic values     : micro-Tesla (uT)
     orientation values  : degrees
     gyroscope values    : degree/s
     temperature values  : degrees centigrade
     proximity values    : distance
     light values        : lux
     pressure values     : hectopascal (hPa)
     humidity            : relative humidity (%)
*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">SENSOR_DEVICE_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ALL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ACCELEROMETER</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GRAVITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_LINEAR_</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ROTATION_VECTOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ORIENTATION</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_LIGHT</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_PROXIMITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_PRESSURE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ULTRAVIOLET</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_TEMPERATURE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMIDITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_GREEN</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_IR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_RED</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE_UNCAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC_UNCAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE_RV</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC_RV</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_HUMAN_PEDOMETER</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_SLEEP_MONITOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_SLEEP_DETECTOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_STRESS_MONITOR</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_EXERCISE_WALKING</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_RUNNING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_HIKING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_CYCLING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_ELLIPTICAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_INDOOR_CYCLING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_ROWING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_STEPPER</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_FUSION</span> <span class="o">=</span> <span class="mh">0x900</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_AUTO_ROTATION</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_AUTO_BRIGHTNESS</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_GESTURE_MOVEMENT</span> <span class="o">=</span> <span class="mh">0x1200</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GESTURE_WRIST_UP</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GESTURE_WRIST_</span>
    <span class="n">SENSOR_DEVICE_GESTURE_MOVEMENT_STATE</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_ACTIVITY_TRACKER</span> <span class="o">=</span> <span class="mh">0x1A00</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ACTIVITY_LEVEL_MONITOR</span><span class="p">,</span>
<span class="p">}</span> <span class="n">sensor_device_type</span><span class="p">;</span>
</code></pre></div></div>

<p>The following code snippet shows the interface of the sensor HAL information in the <code class="highlighter-rouge">sensor_hal_type.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   A platform sensor handler is generated based on this handle
   This ID can be assigned by HAL developer, so it must be unique in 1 sensor_device.
*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_info_t</span> <span class="p">{</span>
    <span class="kt">uint32_t</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">sensor_device_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span> <span class="cm">/* for Internal API */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model_name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">min_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">resolution</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">min_interval</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_batch_count</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">wakeup_supported</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sensor_info_t</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">sensor_accuracy_t</span> <span class="p">{</span>
    <span class="n">SENSOR_ACCURACY_UNDEFINED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_BAD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_NORMAL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_GOOD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_VERYGOOD</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cp">#define SENSOR_DATA_VALUE_SIZE 16
</span>
<span class="cm">/* sensor_data_t */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_data_t</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accuracy</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value_count</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">values</span><span class="p">[</span><span class="n">SENSOR_DATA_VALUE_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">sensor_data_t</span><span class="p">;</span>

<span class="cp">#define SENSOR_PEDOMETER_DATA_DIFFS_SIZE	20
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accuracy</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value_count</span><span class="p">;</span> <span class="cm">/* value_count == 8 */</span>
    <span class="kt">float</span> <span class="n">values</span><span class="p">[</span><span class="n">SENSOR_DATA_VALUE_SIZE</span><span class="p">];</span>
    <span class="cm">/* values = {step count, walk step count, run step count,
	         moving distance, calorie burned, last speed,
	         last stepping frequency (steps per sec),
	         last step status (walking, running, ...)} */</span>
    <span class="cm">/* Additional data attributes (not in sensor_data_t)*/</span>
    <span class="kt">int</span> <span class="n">diffs_count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">differences</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">timestamp</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_up_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_down_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_up_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_down_steps</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">distance</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">calories</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">speed</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">diffs</span><span class="p">[</span><span class="n">SENSOR_PEDOMETER_DATA_DIFFS_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">sensor_pedometer_data_t</span><span class="p">;</span>

<span class="cp">#define CONVERT_TYPE_ATTR(type, index) ((type) &lt;&lt; 8 | 0x80 | (index))
</span>
<span class="k">enum</span> <span class="n">sensor_attribute</span> <span class="p">{</span>
    <span class="n">SENSOR_ATTR_ACTIVITY</span> <span class="o">=</span> <span class="n">CONVERT_TYPE_ATTR</span><span class="p">(</span><span class="n">SENSOR_DEVICE_ACTIVITY_TRACKER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sensor_activity</span> <span class="p">{</span>
    <span class="n">SENSOR_ACTIVITY_UNKNOWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_STILL</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_WALKING</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_RUNNING</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_IN_VEHICLE</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_ON_BICYCLE</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following code snippet shows an example of the <code class="highlighter-rouge">sensor_device</code> implementation for the accelerometer (<code class="highlighter-rouge">sensor-hal-tm1/src/</code>):</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In create.cpp */</span>
<span class="cp">#include &lt;sensor/sensor_hal.h&gt;
#include &lt;sensor_log.h&gt;
#include &lt;vector&gt;
</span>
<span class="cp">#include "accel/accel_device.h"
</span>
<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">sensor_device_t</span><span class="o">&gt;</span> <span class="n">devs</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_sensor</span><span class="o">&gt;</span>
<span class="kt">void</span>
<span class="n">create_sensor</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensor_device</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_sensor</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to create %s sensor device, exception: %s"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"Failed to create %s sensor device"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">devs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">int</span> <span class="n">create</span><span class="p">(</span><span class="n">sensor_device_t</span> <span class="o">**</span><span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ENABLE_ACCEL
</span>    <span class="n">create_sensor</span><span class="o">&lt;</span><span class="n">accel_device</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Accelerometer"</span><span class="p">);</span>
<span class="cp">#endif
</span>
    <span class="o">*</span><span class="n">devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">devs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In accel_device.h */</span>
<span class="cp">#ifndef _ACCEL_DEVICE_H_
#define _ACCEL_DEVICE_H_
</span>
<span class="cp">#include &lt;sensor/sensor_hal.h&gt;
#include &lt;string&gt;
#include &lt;vector&gt;
#include &lt;functional&gt;
</span>
<span class="k">class</span> <span class="nc">accel_device</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor_device</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">accel_device</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">accel_device</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">m_node_handle</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_x</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_y</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_z</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m_polling_interval</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">m_fired_time</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">m_sensorhub_controlled</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">m_method</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_data_node</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_enable_node</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_interval_node</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">update_value</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">event_ids</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">update_value_input_event</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">update_value_iio</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span> <span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* _ACCEL_DEVICE_H_ */</span><span class="cp">
</span></code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In accel_device.cpp */</span>
<span class="cp">#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
</span>
<span class="cp">#include &lt;linux/input.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;poll.h&gt;
</span>
<span class="cp">#include &lt;util.h&gt;
#include &lt;sensor_common.h&gt;
#include &lt;sensor_log.h&gt;
</span>
<span class="cp">#include "accel_device.h"
</span>
<span class="cp">#define MODEL_NAME "K2HH"
#define VENDOR "ST Microelectronics"
#define RESOLUTION 16
#define RAW_DATA_UNIT 0.122
#define MIN_INTERVAL 1
#define MAX_BATCH_COUNT 0
</span>
<span class="cp">#define SENSOR_NAME "SENSOR_ACCELEROMETER"
#define SENSOR_TYPE_ACCEL		"ACCEL"
</span>
<span class="cp">#define INPUT_NAME	"accelerometer_sensor"
#define ACCEL_SENSORHUB_POLL_NODE_NAME "accel_poll_delay"
</span>
<span class="cp">#define GRAVITY 9.80665
#define G_TO_MG 1000
#define RAW_DATA_TO_G_UNIT(X) (((float)(X))/((float)G_TO_MG))
#define RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT(X) (GRAVITY * (RAW_DATA_TO_G_UNIT(X)))
</span>
<span class="cp">#define MIN_RANGE(RES) (-((1 &lt;&lt; (RES))/2))
#define MAX_RANGE(RES) (((1 &lt;&lt; (RES))/2)-1)
</span>
<span class="k">static</span> <span class="n">sensor_info_t</span> <span class="n">sensor_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">id</span><span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">SENSOR_NAME</span><span class="p">,</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">SENSOR_DEVICE_ACCELEROMETER</span><span class="p">,</span>
    <span class="n">event_type</span><span class="o">:</span> <span class="p">(</span><span class="n">SENSOR_DEVICE_ACCELEROMETER</span> <span class="o">&lt;&lt;</span> <span class="n">SENSOR_EVENT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">RAW_DATA_EVENT</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">:</span> <span class="n">MODEL_NAME</span><span class="p">,</span>
    <span class="n">vendor</span><span class="o">:</span> <span class="n">VENDOR</span><span class="p">,</span>
    <span class="n">min_range</span><span class="o">:</span> <span class="n">MIN_RANGE</span><span class="p">(</span><span class="n">RESOLUTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="n">max_range</span><span class="o">:</span> <span class="n">MAX_RANGE</span><span class="p">(</span><span class="n">RESOLUTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="n">resolution</span><span class="o">:</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="n">min_interval</span><span class="o">:</span> <span class="n">MIN_INTERVAL</span><span class="p">,</span>
    <span class="n">max_batch_count</span><span class="o">:</span> <span class="n">MAX_BATCH_COUNT</span><span class="p">,</span>
    <span class="n">wakeup_supported</span><span class="o">:</span> <span class="nb">false</span>
<span class="p">};</span>

<span class="n">accel_device</span><span class="o">::</span><span class="n">accel_device</span><span class="p">()</span>
<span class="o">:</span> <span class="n">m_node_handle</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_y</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_z</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_fired_time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sensorhub_interval_node_name</span> <span class="o">=</span> <span class="n">ACCEL_SENSORHUB_POLL_NODE_NAME</span><span class="p">;</span>

    <span class="n">node_info_query</span> <span class="n">query</span><span class="p">;</span>
    <span class="n">node_info</span> <span class="n">info</span><span class="p">;</span>

    <span class="n">query</span><span class="p">.</span><span class="n">sensorhub_controlled</span> <span class="o">=</span> <span class="n">m_sensorhub_controlled</span> <span class="o">=</span> <span class="n">util</span><span class="o">::</span><span class="n">is_sensorhub_controlled</span><span class="p">(</span><span class="n">sensorhub_interval_node_name</span><span class="p">);</span>
    <span class="n">query</span><span class="p">.</span><span class="n">sensor_type</span> <span class="o">=</span> <span class="n">SENSOR_TYPE_ACCEL</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">INPUT_NAME</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">iio_enable_node_name</span> <span class="o">=</span> <span class="s">"accel_enable"</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">sensorhub_interval_node_name</span> <span class="o">=</span> <span class="n">sensorhub_interval_node_name</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">get_node_info</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to get node info"</span><span class="p">);</span>
        <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">util</span><span class="o">::</span><span class="n">show_node_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

    <span class="n">m_method</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">method</span><span class="p">;</span>
    <span class="n">m_data_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">data_node_path</span><span class="p">;</span>
    <span class="n">m_enable_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">enable_node_path</span><span class="p">;</span>
    <span class="n">m_interval_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">interval_node_path</span><span class="p">;</span>

    <span class="n">m_node_handle</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">m_data_node</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDONLY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_node_handle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"accel handle open fail for accel processor"</span><span class="p">);</span>
        <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_method</span> <span class="o">==</span> <span class="n">INPUT_EVENT_METHOD</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">set_monotonic_clock</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">))</span>
            <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>

        <span class="n">update_value</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">update_value_input_event</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_node_path</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_node_path</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_enable_node_path</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_enable_node_path</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">update_value</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">update_value_iio</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"accel_device is created!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">accel_device</span><span class="o">::~</span><span class="n">accel_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">close</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">);</span>
    <span class="n">m_node_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"accel_device is destroyed!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">m_node_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">sensors</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_info</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">util</span><span class="o">::</span><span class="n">set_enable_node</span><span class="p">(</span><span class="n">m_enable_node</span><span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">SENSORHUB_ACCELEROMETER_ENABLE_BIT</span><span class="p">);</span>
    <span class="n">set_interval</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">);</span>

    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">_I</span><span class="p">(</span><span class="s">"Enable accelerometer sensor"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">util</span><span class="o">::</span><span class="n">set_enable_node</span><span class="p">(</span><span class="n">m_enable_node</span><span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">SENSORHUB_ACCELEROMETER_ENABLE_BIT</span><span class="p">);</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"Disable accelerometer sensor"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">polling_interval_ns</span><span class="p">;</span>

    <span class="n">polling_interval_ns</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000llu</span> <span class="o">*</span> <span class="mi">1000llu</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">m_interval_node</span><span class="p">,</span> <span class="n">polling_interval_ns</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to set polling resource: %s"</span><span class="p">,</span> <span class="n">m_interval_node</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"Interval is changed from %dms to %dms"</span><span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="n">m_polling_interval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">update_value_input_event</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accel_raw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
    <span class="kt">bool</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">read_input_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">INPUT_MAX_BEFORE_SYN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fired_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">syn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">input_event</span> <span class="n">accel_input</span><span class="p">;</span>
    <span class="n">_D</span><span class="p">(</span><span class="s">"accel event detection!"</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">syn</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">read_input_cnt</span> <span class="o">&lt;</span> <span class="n">INPUT_MAX_BEFORE_SYN</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accel_input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">accel_input</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">accel_input</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">_E</span><span class="p">(</span><span class="s">"accel_file read fail, read_len = %d"</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">++</span><span class="n">read_input_cnt</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_REL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">REL_X</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">REL_Y</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">REL_Z</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="n">_E</span><span class="p">(</span><span class="s">"accel_input event[type = %d, code = %d] is unknown."</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>

                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_SYN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">syn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">fired_time</span> <span class="o">=</span> <span class="n">util</span><span class="o">::</span><span class="n">get_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">accel_input</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">_E</span><span class="p">(</span><span class="s">"accel_input event[type = %d, code = %d] is unknown."</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>

            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">syn</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"EV_SYN didn't come until %d inputs had come"</span><span class="p">,</span> <span class="n">read_input_cnt</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">m_x</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">m_y</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">m_z</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="n">fired_time</span><span class="p">;</span>

    <span class="n">_D</span><span class="p">(</span><span class="s">"m_x = %d, m_y = %d, m_z = %d, time = %lluus"</span><span class="p">,</span> <span class="n">m_x</span><span class="p">,</span> <span class="n">m_y</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_fired_time</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">update_value_iio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="kt">int16_t</span> <span class="n">x</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">y</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">z</span><span class="p">;</span>
        <span class="kt">int64_t</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">data</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfd</span><span class="p">;</span>

    <span class="n">pfd</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">m_node_handle</span><span class="p">;</span>
    <span class="n">pfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLERR</span><span class="p">;</span>
    <span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"Failed to poll from m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll timeout m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll exception occurred! m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll nothing to read! m_node_handle:%d, pfd.revents = %d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">,</span> <span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to read data, m_node_handle:%d read_len:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">m_x</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">m_y</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">m_z</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>

    <span class="n">_D</span><span class="p">(</span><span class="s">"m_x = %d, m_y = %d, m_z = %d, time = %lluus"</span><span class="p">,</span> <span class="n">m_x</span><span class="p">,</span> <span class="n">m_y</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_fired_time</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update_value</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_D</span><span class="p">(</span><span class="s">"Failed to update value"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">event_ids</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">event_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sensor_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

    <span class="o">*</span><span class="n">ids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">event_ids</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">sensor_data</span><span class="p">;</span>

    <span class="cm">/* [Important] In HAL, you MUST allocate memory for data.
     * HAL does not need to release this memory because it must be released only after sending this data to clients.
    */</span>
    <span class="n">sensor_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sensor_data_t</span><span class="p">));</span>
    <span class="n">retvm_if</span><span class="p">(</span><span class="o">!</span><span class="n">sensor_data</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="s">"Memory allocation failed"</span><span class="p">);</span>

    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">SENSOR_ACCURACY_GOOD</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">m_fired_time</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">value_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_x</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_y</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_z</span><span class="p">;</span>

    <span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">);</span>

    <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="p">;</span>
    <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sensor_data_t</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="sensorhub">Sensorhub</h4>

<p>The sensorhub HAL supports multiple sensors logically from 1 physical device file. If many sensors are supported by a single device file, the sensorhub HAL can be configured so that it can operate each sensor as a logically-separate device.</p>

<p>The sensor HAL interface is provided to manufacturers and vendors through the <code class="highlighter-rouge">sensor_hal.h</code> and <code class="highlighter-rouge">sensor_hal_types.h</code> header files. It uses just 1 thread for polling sensor events from multiple device files.</p>

<p><strong>Figure: Sensorhub HAL</strong></p>

<p><img src="media/656px-tizen-3-sensorhub2.png" alt="Sensorhub HAL" /></p>

<p>The sensorhub HAL can be developed by using the <code class="highlighter-rouge">sensor_device</code> interface. An example of a sensorhub HAL can be found in the <code class="highlighter-rouge">sensor-hal-tm1/src/sensorhub</code> Git.</p>

<p>IDs can be assigned by the vendor or manufacturer for the sensorhub sensors by using the following <code class="highlighter-rouge">sensor_info_t</code> interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_info_t</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">sensor_device_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span> <span class="cm">/* For Internal API */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model_name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">min_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">resolution</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">min_interval</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_batch_count</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">wakeup_supported</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sensor_info_t</span><span class="p">;</span>
</code></pre></div></div>

<p>The following code snippet shows an example of a sensorhub HAL implementation:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;algorithm&gt;
#include &lt;sensor_log.h&gt;
</span>
<span class="cp">#include "sensorhub.h"
#include "sensorhub_controller.h"
#include "sensorhub_manager.h"
#include "system_state.h"
</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">sensorhub_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_instance</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to allocated memory"</span><span class="p">);</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensorhub_manager</span><span class="o">::</span><span class="n">get_instance</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">manager</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to allocated memory"</span><span class="p">);</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_controller</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">set_controller</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>

    <span class="n">INFO</span><span class="p">(</span><span class="s">"sensorhub_device is created!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">sensorhub_device</span><span class="o">::~</span><span class="n">sensorhub_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"sensorhub_device is destroyed!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">get_poll_fd</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensors</span><span class="p">(</span><span class="n">sensors</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">initialize</span><span class="p">();</span>

    <span class="n">controller</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">();</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to enable sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">finalize</span><span class="p">();</span>

    <span class="n">controller</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to disable sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set interval to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_interval</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_batch_latency</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set batch latency to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_batch_latency</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_attribute_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set attribute to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_attribute_int</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to send sensorhub data"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WARN</span><span class="p">(</span><span class="s">"Command is sent during sensorhub firmware update"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_attribute_str</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set attribute to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_attribute_str</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to send sensorhub data"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WARN</span><span class="p">(</span><span class="s">"Command is sent during sensorhub firmware update"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_data_t</span> <span class="n">data</span><span class="p">;</span>

    <span class="cm">/* Step 1 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">read_fd</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Step 2 */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">value_count</span><span class="p">;</span>

    <span class="cm">/* Step 3 */</span>
    <span class="n">event_ids</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG</span><span class="p">(</span><span class="s">"Remaining data length: %d"</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">hub_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ERR</span><span class="p">(</span><span class="s">"Parsing failed"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">data_len</span> <span class="o">-=</span> <span class="n">parsed</span><span class="p">;</span>
        <span class="n">hub_data</span> <span class="o">+=</span> <span class="n">parsed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Step 4 */</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">event_ids</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">event_ids</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="n">ids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">remains</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to get data from sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">remains</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">remains</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">flush</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">hub_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">hub_data</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">libtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">libtype</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Unknown Sensorhub lib type: %d"</span><span class="p">,</span> <span class="n">libtype</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">event_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse_debug</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;dirent.h&gt;
#include &lt;linux/input.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;fstream&gt;
</span>
<span class="cp">#include &lt;sensor_log.h&gt;
#include &lt;util.h&gt;
#include "sensorhub_controller.h"
</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">sensorhub_controller</span><span class="p">()</span>
<span class="o">:</span> <span class="n">m_enabled</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_poll_node</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_data_node</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">sensorhub_controller</span><span class="o">::~</span><span class="n">sensorhub_controller</span><span class="p">()</span> <span class="p">{}</span>

<span class="n">sensorhub_controller</span><span class="o">&amp;</span> <span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">sensorhub_controller</span> <span class="n">instance</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Returns the sensorhub fd */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"Enable Sensorhub"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"Disable Sensorhub"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">open_input_node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">input_node</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="n">sensorhub_data_t</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_sensorhub_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_large_sensorhub_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">send_sensorhub_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">print_sensorhub_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="references">References</h3>

<p>The reference kernel configuration for sensors varies depending on vendor types. However, there is a standard kernel subsystem for sensors: the Industrial I/O (IIO) subsystem. IIO is intended to provide support for devices that are, in some sense, analog to digital or digital to analog.
For more information, see <a href="https://wiki.analog.com/software/linux/docs/iio/iio">https://wiki.analog.com/software/linux/docs/iio/iio</a>.</p>

<p>The following table lists some example kernel configurations.</p>

<p><strong>Table: Example kernel configurations</strong></p>

<table>
  <thead>
    <tr>
      <th>Sensor component</th>
      <th>Kernel configuration</th>
      <th>Device nodes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Accelerometer</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_KR3DH</code></td>
      <td><code class="highlighter-rouge">/dev/input/event0/</code>, <code class="highlighter-rouge">/dev/input/event1/</code>, <code class="highlighter-rouge">/dev/input/event2/</code>, <code class="highlighter-rouge">/dev/input/event3/</code>, <code class="highlighter-rouge">/dev/input/event4/</code>, <code class="highlighter-rouge">/dev/input/event5/</code></td>
    </tr>
    <tr>
      <td>Proximity</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_GP2A</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>Light sensor</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_GP2A</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>Electronic compass</td>
      <td><code class="highlighter-rouge">CONFIG_SENSORS_AK8975</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="project-git-repositories">Project Git Repositories</h3>

<p>The following table lists the available project Git repositories.</p>

<p><strong>Table: Git repositories</strong></p>

<table>
  <thead>
    <tr>
      <th>Project</th>
      <th>Repository</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">capi-system-sensor</code></td>
      <td><code class="highlighter-rouge">platform/core/api/sensor</code></td>
      <td>Tizen sensor C-API</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensord</code></td>
      <td><code class="highlighter-rouge">platform/core/system/sensord</code></td>
      <td>Sensor daemon and libraries for managing sensors and clients</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tm1</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tm1/sensor-hal-tm1</code></td>
      <td>Sensor HAL for the TM1 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tm2</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tm2/sensor-hal-tm2</code></td>
      <td>Sensor HAL for the TM2 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tw1</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tw1/sensor-hal-tw1</code></td>
      <td>Sensor HAL for the TW1 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-emulator</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/emulator/sensor-hal-emulator</code></td>
      <td>Sensor HAL for the emulator</td>
    </tr>
  </tbody>
</table>

<h3 id="testing-and-verifying-sensors">Testing and Verifying Sensors</h3>

<p>The <code class="highlighter-rouge">sensor-test package</code>, in the <code class="highlighter-rouge">sensord</code> Git repository, provides <code class="highlighter-rouge">sensorctl</code>, a command-line tool for testing sensors. After installing <code class="highlighter-rouge">sensor-test package</code>, you can test sensors using the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sensorctl <span class="nb">test </span>accelerometer
<span class="nv">$ </span>sensorctl <span class="nb">test </span>gyroscope
<span class="nv">$ </span>sensorctl <span class="nb">test </span>accelerometer 100 /<span class="k">*</span> <span class="nb">enable </span>accelerometer with interval 100 ms <span class="k">*</span>/
<span class="nv">$ </span>sensorctl <span class="nb">test </span>accelerometer 100 1000 /<span class="k">*</span> <span class="nb">enable </span>accelerometer with interval 100 ms and 1s batch latency <span class="k">*</span>/
<span class="nv">$ </span>sensorctl <span class="nb">test </span>accelerometer 100 1000 0 /<span class="k">*</span> <span class="nb">enable </span>accelerometer with interval 100 ms, 1s batch latency and always on option <span class="k">*</span>/
<span class="nv">$ </span>sensorctl info accelerometer /<span class="k">*</span> retrieve accelerometer sensor information <span class="k">*</span>/
</code></pre></div></div>

    <!-- Page info -->
<p class="text-muted small">

  


  <br>
  Last updated May 28, 2018


</p>
<!-- Page info end -->
  </div>
  <aside class="side-nav">
    <!-- Page navigation -->
<link href="/assets/css/pagenav.css" rel="stylesheet">
<div class="table-of-content" id="pagenav-table">
  <div class="table-of-content-header"><a href="#">Index</a></div>
  <div class="table-of-content-anchors">
    <ul class="anchor-list" id="pagenav-index"/>
  </div>
</div>
<script src="/assets/js/pagenav.js"></script>
<!-- Page navigation end -->
  </aside>
</main>

</div>

  <!-- Floating button -->
  <!--
  <a href="#" style="position: fixed; bottom: 20px; right: 20px;" class="btn btn-light">
    <i class="fa fa-arrow-up"></i>
  </a>
  -->
</body>
</html>
